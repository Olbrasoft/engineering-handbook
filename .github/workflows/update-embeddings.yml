name: Update Handbook Embeddings

on:
  push:
    branches: [main]
    paths:
      - '**/*.md'

jobs:
  update-embeddings:
    runs-on: [self-hosted, handbook-search]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit for diff

      - name: Get changed markdown files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            **/*.md

      - name: Display changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed markdown files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

      - name: Setup .NET environment
        run: |
          echo "PATH=/home/jirka/.dotnet:$PATH" >> $GITHUB_ENV
          echo "DOTNET_ROOT=/home/jirka/.dotnet" >> $GITHUB_ENV

      - name: Delete removed files from HandbookSearch
        if: steps.changed-files.outputs.deleted_files != ''
        working-directory: ${{ github.workspace }}
        run: |
          deleted_count=0

          for file in ${{ steps.changed-files.outputs.deleted_files }}; do
            echo "::group::Deleting: $file"

            # Run from CLI directory to ensure appsettings.json is found
            if (cd /opt/olbrasoft/handbook-search/cli && ./HandbookSearch.Cli delete-files --files "$file"); then
              echo "::notice::Successfully deleted: $file"
              deleted_count=$((deleted_count + 1))
            else
              echo "::warning::Failed to delete (may not exist in DB): $file"
            fi

            echo "::endgroup::"
          done

          echo "✅ Deleted $deleted_count file(s)"
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=handbook_search;Username=postgres;Password=${{ secrets.POSTGRES_PASSWORD }}"

      - name: Import added/modified files to HandbookSearch
        if: steps.changed-files.outputs.added_files != '' || steps.changed-files.outputs.modified_files != ''
        working-directory: ${{ github.workspace }}
        run: |
          failed=0
          success=0

          # Process added and modified files
          for file in ${{ steps.changed-files.outputs.added_files }} ${{ steps.changed-files.outputs.modified_files }}; do
            echo "::group::Importing: $file"

            # Get absolute path to the file
            file_path="${{ github.workspace }}/$file"

            if [ ! -f "$file_path" ]; then
              echo "::warning::File not found: $file_path"
              failed=$((failed + 1))
              echo "::endgroup::"
              continue
            fi

            # Import using deployed HandbookSearch.Cli
            # Run from CLI directory to ensure appsettings.json is found
            # Pass handbook-path to ensure correct relative path calculation
            # Export environment variables to ensure they're available in subshell
            if (cd /opt/olbrasoft/handbook-search/cli && \
                AzureTranslator__ApiKey="$AZURE_TRANSLATOR_API_KEY" \
                ConnectionStrings__DefaultConnection="$ConnectionStrings__DefaultConnection" \
                Ollama__BaseUrl="$Ollama__BaseUrl" \
                Ollama__Model="$Ollama__Model" \
                Ollama__Dimensions="$Ollama__Dimensions" \
                ./HandbookSearch.Cli import-files \
                --files "$file_path" \
                --handbook-path "${{ github.workspace }}" \
                --translate-cs); then
              echo "::notice::Successfully imported: $file (+Czech embedding)"
              success=$((success + 1))
            else
              echo "::error::Failed to import: $file"
              failed=$((failed + 1))
            fi

            echo "::endgroup::"
          done

          echo ""
          echo "✅ Import summary:"
          echo "   Success: $success"
          echo "   Failed:  $failed"
          echo "   Total:   $(( success + failed ))"

          if [ $failed -gt 0 ]; then
            echo "::error::$failed file(s) failed to import"
            exit 1
          fi
        env:
          ConnectionStrings__DefaultConnection: "Host=localhost;Database=handbook_search;Username=postgres;Password=${{ secrets.POSTGRES_PASSWORD }}"
          AZURE_TRANSLATOR_API_KEY: "${{ secrets.AZURE_TRANSLATOR_API_KEY }}"
          Ollama__BaseUrl: "http://localhost:11434"
          Ollama__Model: "qwen3-embedding:0.6b"
          Ollama__Dimensions: "1024"
