name: Check File Size for Translation

on:
  pull_request:
    paths:
      - '**.md'
  push:
    branches:
      - main
    paths:
      - '**.md'

jobs:
  check-file-size:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check markdown file sizes
        run: |
          #!/bin/bash
          set -e

          MAX_CHARS=30000
          MAX_KB=30
          FAILED=false

          echo "Checking markdown files for translation size limits..."
          echo "Maximum allowed: $MAX_CHARS characters (~$MAX_KB KB)"
          echo ""

          # Get list of changed .md files (for PRs)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            FILES=$(git diff --name-only --diff-filter=ACM origin/${{ github.base_ref }}...${{ github.sha }} | grep '\.md$' || true)
          else
            # For pushes to main, check all .md files
            FILES=$(find . -name "*.md" -not -path "./.git/*" || true)
          fi

          if [ -z "$FILES" ]; then
            echo "No markdown files to check."
            exit 0
          fi

          echo "Files to check:"
          echo "$FILES"
          echo ""

          for FILE in $FILES; do
            if [ ! -f "$FILE" ]; then
              continue
            fi

            # Count characters (not bytes)
            CHAR_COUNT=$(wc -m < "$FILE")
            SIZE_KB=$(du -k "$FILE" | cut -f1)

            if [ "$CHAR_COUNT" -gt "$MAX_CHARS" ]; then
              echo "❌ FAIL: $FILE"
              echo "   Characters: $CHAR_COUNT (exceeds $MAX_CHARS by $((CHAR_COUNT - MAX_CHARS)) characters)"
              echo "   Size: ${SIZE_KB} KB"
              echo "   Reason: File too large for translation API (Azure Translator: ~33,300 chars/minute)"
              echo "   Solution: Split file into smaller parts (<$MAX_CHARS chars each)"
              echo ""
              FAILED=true
            else
              echo "✅ PASS: $FILE"
              echo "   Characters: $CHAR_COUNT / $MAX_CHARS"
              echo "   Size: ${SIZE_KB} KB"
              echo ""
            fi
          done

          if [ "$FAILED" = true ]; then
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "❌ CHECK FAILED: One or more files exceed the 30,000 character limit"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "Translation APIs have character limits:"
            echo "  - Azure Translator: ~33,300 chars/minute"
            echo "  - DeepL: Max 50,000 chars/request"
            echo ""
            echo "Files exceeding 30,000 characters (~30 KB) should be split into"
            echo "smaller, focused documents for better maintainability and translation."
            echo ""
            echo "See: contributing/structure-contributing.md"
            echo ""
            exit 1
          fi

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ All markdown files are within size limits!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
